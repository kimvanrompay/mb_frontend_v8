<!-- M3 Dashboard Content -->

<!-- Header -->
<div class="mb-6 flex items-center justify-between">
    <h1 class="text-[24px] font-normal text-on-surface">Overview</h1>

    <!-- Action Buttons (M3 Styles) -->
    <div class="flex items-center gap-3">
        <!-- Add Team Members (Outlined Button) -->
        <div class="relative group">
            <a routerLink="/team-upgrade"
                class="flex items-center gap-2 px-6 h-10 border border-outline rounded-full text-sm font-medium text-primary hover:bg-primary-container/10 transition-colors cursor-pointer">
                <span class="material-icons text-[18px]">group_add</span>
                Add Team Members
            </a>
            <!-- Tooltip (Keep existing logic, restyle container) -->
            <div class="absolute top-full mt-2 right-0 w-80 p-4 bg-inverse-surface text-inverse-on-surface rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-8 h-8 bg-tertiary-container text-on-tertiary-container rounded-full flex items-center justify-center">
                        <span class="text-xs font-bold">PRO</span>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium mb-1">Upgrade to add team members</h4>
                        <p class="text-xs opacity-80 leading-relaxed">Collaborate with your team and access powerful platform features with a Professional plan.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Dropdown Button (Filled Button) -->
        <div class="relative" (clickOutside)="closeDropdown()">
            <button (click)="toggleDropdown()"
                class="flex items-center gap-2 px-6 h-10 bg-primary text-on-primary rounded-full text-sm font-medium hover:shadow-md transition-shadow">
                <span class="material-icons text-[18px]">add</span>
                New
                <span class="material-icons text-[18px] transition-transform" [class.rotate-180]="isDropdownOpen">arrow_drop_down</span>
            </button>

            <!-- Dropdown Menu (M3 Menu) -->
            <div *ngIf="isDropdownOpen"
                class="absolute right-0 mt-2 w-56 bg-surface-container-high rounded-lg shadow-lg py-2 z-50 overflow-hidden">
                
                <button (click)="openNewPositionModal()"
                    class="w-full text-left flex items-center gap-3 px-4 py-3 text-sm text-on-surface hover:bg-surface-container-highest transition-colors">
                    <span class="material-icons text-on-surface-variant text-[20px]">work</span>
                    Position
                </button>

                <a routerLink="/applications/new"
                    class="flex items-center gap-3 px-4 py-3 text-sm text-on-surface hover:bg-surface-container-highest transition-colors">
                    <span class="material-icons text-on-surface-variant text-[20px]">assignment</span>
                    Application
                </a>

                <a routerLink="/candidates/new"
                    class="flex items-center gap-3 px-4 py-3 text-sm text-on-surface hover:bg-surface-container-highest transition-colors">
                    <span class="material-icons text-on-surface-variant text-[20px]">person</span>
                    Candidate
                </a>

                <div class="border-t border-outline-variant my-1"></div>

                <a routerLink="/assessments/new"
                    class="flex items-center gap-3 px-4 py-3 text-sm text-on-surface hover:bg-surface-container-highest transition-colors">
                    <span class="material-icons text-on-surface-variant text-[20px]">quiz</span>
                    Assessment
                </a>
            </div>
        </div>
    </div>
</div>

<!-- KPI Grid (M3 Cards) -->
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
    <!-- Active Positions -->
    <div class="p-4 rounded-[16px] bg-surface-container-lowest border border-outline-variant flex flex-col justify-between h-[104px]">
        <span class="text-[12px] font-medium text-on-surface-variant tracking-wide">ACTIVE POSITIONS</span>
        <div class="flex items-end gap-2">
            <span class="text-[32px] font-normal text-on-surface leading-none">{{ stats.activePositions }}</span>
            <span class="text-[12px] font-medium text-green-600 mb-1 flex items-center">
                +12%
            </span>
        </div>
    </div>

    <!-- Total Candidates -->
    <div class="p-4 rounded-[16px] bg-surface-container-lowest border border-outline-variant flex flex-col justify-between h-[104px]">
        <span class="text-[12px] font-medium text-on-surface-variant tracking-wide">TOTAL CANDIDATES</span>
        <div class="flex items-end gap-2">
            <span class="text-[32px] font-normal text-on-surface leading-none">{{ stats.totalCandidates }}</span>
            <span class="text-[12px] font-medium text-green-600 mb-1 flex items-center">
                +8%
            </span>
        </div>
    </div>

    <!-- In Assessment -->
    <div class="p-4 rounded-[16px] bg-surface-container-lowest border border-outline-variant flex flex-col justify-between h-[104px]">
        <span class="text-[12px] font-medium text-on-surface-variant tracking-wide">IN ASSESSMENT</span>
        <div class="flex items-end gap-2">
            <span class="text-[32px] font-normal text-on-surface leading-none">{{ stats.inAssessment }}</span>
            <span class="text-[12px] font-medium text-green-600 mb-1 flex items-center">
                +5%
            </span>
        </div>
    </div>

    <!-- Reviews Pending -->
    <div class="p-4 rounded-[16px] bg-surface-container-lowest border border-outline-variant flex flex-col justify-between h-[104px]">
        <span class="text-[12px] font-medium text-on-surface-variant tracking-wide">REVIEWS PENDING</span>
        <div class="flex items-end gap-2">
            <span class="text-[32px] font-normal text-on-surface leading-none">{{ stats.reviewsPending }}</span>
            <span class="text-[12px] font-medium text-error mb-1 flex items-center">
                -3%
            </span>
        </div>
    </div>

    <!-- Avg Integrity -->
    <div class="p-4 rounded-[16px] bg-surface-container-lowest border border-outline-variant flex flex-col justify-between h-[104px]">
        <span class="text-[12px] font-medium text-on-surface-variant tracking-wide">AVG. INTEGRITY</span>
        <div class="flex items-end gap-2">
            <span class="text-[32px] font-normal text-on-surface leading-none">{{ stats.avgIntegrity }}</span>
            <span class="text-[12px] font-medium text-green-600 mb-1 flex items-center">
                +4%
            </span>
        </div>
    </div>

    <!-- Completion Rate -->
    <div class="p-4 rounded-[16px] bg-surface-container-lowest border border-outline-variant flex flex-col justify-between h-[104px]">
        <span class="text-[12px] font-medium text-on-surface-variant tracking-wide">COMPLETION RATE</span>
        <div class="flex items-end gap-2">
            <span class="text-[32px] font-normal text-on-surface leading-none">{{ stats.completionRate }}%</span>
            <span class="text-[12px] font-medium text-green-600 mb-1 flex items-center">
                +6%
            </span>
        </div>
    </div>
</div>

<!-- Activity Heatmap - Second Row (M3 Card) -->
<div class="p-6 rounded-[16px] bg-surface-container-lowest border border-outline-variant mb-6">
    <h3 class="text-[16px] font-medium text-on-surface mb-6">Assessment Activity</h3>
    <app-activity-heatmap></app-activity-heatmap>
</div>

<!-- Symmetric 3-Column Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">

    <!-- Capability Assessment -->
    <div class="p-6 rounded-[16px] bg-surface-container-lowest border border-outline-variant h-[340px] flex flex-col">
        <h3 class="text-[14px] font-medium text-on-surface mb-4 flex items-center gap-2">
            <span class="w-2 h-2 bg-primary rounded-full"></span>
            Capability Assessment
        </h3>
        <div class="flex-1 flex items-center justify-center">
            <app-skill-breakdown></app-skill-breakdown>
        </div>
    </div>

    <!-- Bias Score -->
    <div class="p-6 rounded-[16px] bg-surface-container-lowest border border-outline-variant h-[340px] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-[14px] font-medium text-on-surface">Bias Score</h3>
            <span class="text-[11px] px-2 py-1 bg-green-100 text-green-800 rounded-md font-medium">LOW BIAS</span>
        </div>
        <div class="flex-1 flex items-center justify-center">
            <app-gauge-trust></app-gauge-trust>
        </div>
    </div>

    <!-- Application Sources -->
    <div class="p-6 rounded-[16px] bg-surface-container-lowest border border-outline-variant h-[340px] flex flex-col">
        <h3 class="text-[14px] font-medium text-on-surface mb-6 flex items-center gap-2">
            <span class="w-2 h-2 bg-tertiary rounded-full"></span>
            Application Sources
        </h3>
        <div class="flex flex-col justify-center h-full space-y-6">
            <div class="space-y-2">
                <div class="flex justify-between items-center text-[12px]">
                    <span class="text-on-surface-variant">LinkedIn</span>
                    <span class="font-medium text-on-surface">N/A</span>
                </div>
                <div class="w-full bg-surface-container-high h-2 rounded-full overflow-hidden">
                    <div class="bg-tertiary h-2 rounded-full w-0"></div>
                </div>
            </div>

            <div class="space-y-2">
                <div class="flex justify-between items-center text-[12px]">
                    <span class="text-on-surface-variant">Direct Application</span>
                    <span class="font-medium text-on-surface">N/A</span>
                </div>
                <div class="w-full bg-surface-container-high h-2 rounded-full overflow-hidden">
                    <div class="bg-tertiary h-2 rounded-full w-0 opacity-80"></div>
                </div>
            </div>

            <div class="space-y-2">
                <div class="flex justify-between items-center text-[12px]">
                    <span class="text-on-surface-variant">Referral</span>
                    <span class="font-medium text-on-surface">N/A</span>
                </div>
                <div class="w-full bg-surface-container-high h-2 rounded-full overflow-hidden">
                    <div class="bg-tertiary h-2 rounded-full w-0 opacity-60"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Bottom Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

    <!-- Recent Candidates -->
    <div class="p-6 rounded-[16px] bg-surface-container-lowest border border-outline-variant h-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-[14px] font-medium text-on-surface flex items-center gap-2">
                <span class="w-2 h-2 bg-primary rounded-full"></span>
                Recent Candidates
            </h3>
            <a routerLink="/candidates"
                class="text-[12px] font-medium text-primary hover:text-primary-container transition-colors cursor-pointer">VIEW ALL</a>
        </div>
        <div class="space-y-2">
            <app-card-candidate-row *ngFor="let c of recentCandidates" 
                [name]="c.name" 
                [role]="c.role" 
                [score]="c.score"
                [status]="c.status">
            </app-card-candidate-row>
        </div>
    </div>

    <!-- Today's Activity -->
    <div class="p-6 rounded-[16px] bg-surface-container-lowest border border-outline-variant h-full">
        <h3 class="text-[14px] font-medium text-on-surface mb-4 flex items-center gap-2">
            <span class="w-2 h-2 bg-secondary rounded-full"></span>
            Today's Activity
        </h3>
        <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-surface-container-high rounded-xl">
                <div class="text-[11px] text-on-surface-variant uppercase mb-1">Tests Started</div>
                <div class="text-[24px] font-normal text-on-surface">{{ stats.testsStarted }}</div>
            </div>
            <div class="p-4 bg-surface-container-high rounded-xl">
                <div class="text-[11px] text-on-surface-variant uppercase mb-1">Completed</div>
                <div class="text-[24px] font-normal text-on-surface">{{ stats.testsCompleted }}</div>
            </div>
            <div class="p-4 bg-secondary-container rounded-xl">
                <div class="text-[11px] text-on-secondary-container uppercase mb-1">Live Now</div>
                <div class="text-[24px] font-normal text-on-secondary-container flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    {{ stats.liveNow }}
                </div>
            </div>
            <div class="p-4 bg-surface-container-high rounded-xl">
                <div class="text-[11px] text-on-surface-variant uppercase mb-1">Avg. Duration</div>
                <div class="text-[24px] font-normal text-on-surface">{{ stats.avgDuration }}m</div>
            </div>
        </div>
    </div>

</div>

<!-- New Position Modal (M3 Dialog) -->
<div *ngIf="isNewPositionModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100]"
    (click)="closeNewPositionModal()">
    <div class="bg-surface-container-high rounded-[28px] shadow-2xl max-w-lg w-full mx-4 overflow-hidden" (click)="$event.stopPropagation()">
        <!-- Header -->
        <div class="px-6 py-6 border-b border-outline-variant">
            <h2 class="text-[24px] font-normal text-on-surface">Create a position</h2>
            <p class="text-[14px] text-on-surface-variant mt-1">Define a new job opening to start receiving applications.</p>
        </div>

        <!-- Trial Limit -->
        <div *ngIf="!canCreatePosition" class="mx-6 mt-4 p-4 bg-tertiary-container rounded-xl">
            <div class="flex items-start gap-3">
                <span class="material-icons text-on-tertiary-container">lock</span>
                <div>
                    <h4 class="text-sm font-bold text-on-tertiary-container mb-1">Upgrade to create more positions</h4>
                    <p class="text-xs text-on-tertiary-container mb-3">Trial accounts are limited to {{maxPositionsInTrial}} position.</p>
                    <a routerLink="/billing" class="text-xs font-bold underline cursor-pointer text-on-tertiary-container">Upgrade Now</a>
                </div>
            </div>
        </div>

        <!-- Form -->
        <div class="px-6 py-4 space-y-4" [class.opacity-50]="!canCreatePosition" [class.pointer-events-none]="!canCreatePosition">
            <!-- Inputs (M3 Styled) -->
            <div>
                <label class="block text-xs font-medium text-on-surface-variant mb-1">Position title</label>
                <input type="text" [(ngModel)]="newPosition.title" 
                    class="w-full h-14 px-4 bg-surface rounded-t-lg border-b border-outline-variant focus:border-primary focus:outline-none transition-colors"
                    placeholder="e.g., Senior Frontend Developer" />
            </div>
            <!-- ... other inputs similarly styled ... -->
        </div>

        <!-- Actions -->
        <div class="px-6 py-6 flex justify-end gap-2">
            <button (click)="closeNewPositionModal()"
                class="px-6 h-10 text-primary font-medium hover:bg-primary-container/10 rounded-full transition-colors">
                Cancel
            </button>
            <button (click)="createPosition()" [disabled]="!newPosition.title || !canCreatePosition"
                class="px-6 h-10 bg-primary text-on-primary font-medium rounded-full hover:shadow-md disabled:opacity-50 transition-all">
                Create
            </button>
        </div>
    </div>
</div>
